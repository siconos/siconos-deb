#!/usr/bin/make -f

# export DH_VERBOSE=1
# export CC=mpicc
# export FC=mpif90
# export CXX=mpicxx

# Build with clang because g++-6 gives some errors on this version of Siconos
export CC=clang
export CXX=clang++

LDFLAGS=-Wl,--as-needed

BUILDDIR=$(CURDIR)/obj-$(DEB_HOST_GNU_TYPE)
LIBDIR=$(CURDIR)/debian/tmp/usr/lib/$(DEB_HOST_MULTIARCH)
DOCDIR=$(CURDIR)/debian/siconos-doc/usr/share/doc/siconos-doc

COMPONENTS := numerics kernel mechanics io control
SOVERSION := 0

%:
	dh $@ --with python2,sphinxdoc --parallel

override_dh_auto_clean:
	dh_auto_clean
# These files are generated by CMake in the source directory
	rm -f Docs/sphinx/conf.py \
	      Docs/sphinx/index.rst \
	      Docs/sphinx/reference/siconos_api_reference.rst

# Notes: We remove rpath due to Debian policy, and since
# liblpsolve55.so is a private library in the lp-solve package, we
# instead use the static library available in liblpsolve55-dev.
#
# We add SOVERSION=0 since it is not specified in the CMake.  Future
# upstream versions will bump SICONOS_SOVERSION accordingly, so this
# should not be necessary.
override_dh_auto_configure:
	echo 'set(SICONOS_SOVERSION "$(SOVERSION)")' >>cmake/SiconosVersion.cmake
	sed -i -e \
    's,\(VERSION "$${SICONOS_VERSION}"\),\1 SOVERSION "$${SICONOS_SOVERSION}",' \
	  cmake/LibraryProjectSetup.cmake
	sed -i -e \
		's,set_target_properties(\(.*\)NO_SONAME ON),set_target_properties(\1SOVERSION "$${SICONOS_SOVERSION}"),' \
		cmake/UseSWIG.cmake

# Build libsiconos-externals as a static library
	sed -i -e \
	  's,if(NOT BUILD_SHARED_LIBS),if(("$${COMPONENT}" STREQUAL "externals") OR (NOT BUILD_SHARED_LIBS)),' \
	  cmake/LibraryProjectSetup.cmake
	sed -i -e \
	  's,add_library($${COMPONENT} STATIC $${$${COMPONENT}_SRCS}),add_library($${COMPONENT} STATIC $${$${COMPONENT}_SRCS})\nif("$${COMPONENT}" STREQUAL "externals")\nset_property(TARGET externals PROPERTY POSITION_INDEPENDENT_CODE ON)\nendif(),' \
	  cmake/LibraryProjectSetup.cmake

	dh_auto_configure -- \
		-DFORCE_SKIP_RPATH=1 \
		-DCMAKE_SKIP_INSTALL_RPATH=TRUE \
		-DCMAKE_SKIP_BUILD_RPATH=TRUE \
		-DCMAKE_SKIP_RPATH=TRUE \
		-DI_WANT_STATIC_LPSOLVE=TRUE \
		-DLpSolve_LIBRARY=/usr/lib/liblpsolve55_pic.a \
		-DNO_RUNTIME_BUILD_DEP=1 \
		-Dpython_install_options=--install-layout=deb \
		-DGAMS_DIR_INSOURCE=1 \
		-DWITH_UMFPACK=1 \
		-DWITH_BULLET=1 \
		-DWITH_HDF5=1 \
		-DWITH_DOCUMENTATION=1 \
		-DWITH_DOXY2SWIG=1

# Error: FindMUMPS.cmake:47 get_filename_component called with incorrect number of arguments
# -DWITH_MUMPS=1 \

override_dh_auto_install:
	dh_auto_install
	dh_numpy

# split up header files according to component;
# we use find and ls to identify only installed header files that are
# found within a component's directory
	for C in $(COMPONENTS); do \
	  find $(CURDIR)/$${C} -name \*.h -printf 'debian/tmp/usr/include/siconos/%f\0' \
	    -or -name \*.hpp -printf 'debian/tmp/usr/include/siconos/%f\0' \
		| xargs -0 ls 2>/dev/null \
	  | while read i; do \
	    dh_install -p libsiconos-$${C}$(SOVERSION)-dev $$i usr/include/siconos/; \
	  done; \
	done

override_dh_installdocs-indep:
# launch 'make doc' with correct paths to generate docs; this should
# go in 'build', but it must be done after install due to sphinx
# needing to load SWIG-compiled modules during doc build.

# FIXME: remove $(CURDIR)/debian when sphinxcontrib packages become available.
# FIXME: remove /usr/lib/python2.7 and the ../dist-packages/siconos path in future versions where the 'import kernel' bug is fixed.
	env PYTHONPATH=/usr/lib/python2.7:$(CURDIR)/debian/tmp/$(wildcard /usr/lib/python2*/dist-packages)/siconos:$(CURDIR)/debian/tmp/$(wildcard /usr/lib/python2*/dist-packages):$(CURDIR)/debian/python2.7/site-packages LD_LIBRARY_PATH=$(LIBDIR) $(MAKE) -C $(BUILDDIR) doc

	dh_installdocs -p siconos-doc $(BUILDDIR)/Docs/build/html
	dh_installexamples -p siconos-examples examples/*

# Some weird old mistakes that trigger lintian errors
	sed -i -e 's,#/bin/sh,#!/bin/sh,' debian/siconos-examples/usr/share/doc/siconos-examples/examples/Biology/StepSystem/script.sh
	sed -i -e 's,#/bin/sh,#!/bin/sh,' debian/siconos-examples/usr/share/doc/siconos-examples/examples/Biology/StepSystem/script-sign.sh
# Remove unwanted files
	find debian/siconos-examples -name Thumbs.db -exec rm -v {} \;
	find debian/siconos-examples -name Thumbs.db.gz -exec rm -v {} \;
	rm debian/siconos-examples/usr/share/doc/siconos-examples/examples/Robotics/HuMAns_pa10/RobotSim/lib/pa10.tar.gz
	find debian/siconos-examples/usr/share/doc/siconos-examples/examples/Mechanics/Mechanisms -name env.sh -exec rm -v {} \;
	find debian/siconos-examples/usr/share/doc/siconos-examples/examples/Mechanics/Mechanisms -name env.csh -exec rm -v {} \;
	rm -rf debian/siconos-examples/usr/share/doc/siconos-examples/examples/{src,figures,cmake,CMakeLists.txt,ChangeLog,CI,CTestConfig.cmake,config}

override_dh_fixperms-indep:
	dh_fixperms
# Remove exec permissions of stp/step/cpp/h files (lintian error)
	find debian/siconos-examples -name \*.stp -exec chmod 644 {} \;
	find debian/siconos-examples -name \*.step -exec chmod 644 {} \;
	find debian/siconos-examples -name \*.cpp -exec chmod 644 {} \;
	find debian/siconos-examples -name \*.h -exec chmod 644 {} \;

override_dh_sphinxdoc-indep:
# If we delete these files, then dh_sphinxdoc complains that they are missing.
# If we don't delete them, then lintian complains with privacy-breach-uses-embedded-file
# In the end, uable to call dh_sphinxdoc without errors.
# (Even after "ignoring" all js files, it complains about modified search.html, etc.)
# Decision: don't use dh_sphinxdoc for now, just fix up the js urls using sed
#	dh_sphinxdoc -p siconos-doc -X bootstrap-sphinx.js -X bootstrap.min.js -X doctools.js -X jquery-1.11.0.js -X jquery-1.11.1.js -X jquery-1.11.0.min.js -X jquery-1.11.1.min.js -X jquery.js -X jquery-fix.js -X searchtools.js -X underscore-1.3.1.js -X underscore.js -X websupport.js -X MathJax.js usr/share/doc/siconos-doc/html

	rm -vf $(DOCDIR)/html/_sources/license.txt
	rm -vf $(DOCDIR)/html/_static/jquery.js
	rm -vf $(DOCDIR)/html/doxygen/html/jquery.js
	rm -vrf $(DOCDIR)/html/_static/js/jquery*
	rm -vf $(DOCDIR)/html/_static/underscore.js
	find $(DOCDIR)/html -name \*.html -exec sed -i {} -e s,https://cdn.mathjax.org/mathjax/latest/MathJax.js,/usr/share/javascript/mathjax/MathJax.js,g \;
	find $(DOCDIR)/html -name \*.html -exec sed -i {} -e s,../_static/jquery.js,/usr/share/javascript/jquery/jquery.js,g \;
	find $(DOCDIR)/html -name \*.html -exec sed -i {} -e s,../_static/underscore.js,/usr/share/javascript/underscore/underscore.js,g \;
	find $(DOCDIR)/html -name \*.html -exec sed -i {} -e s,'<script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>',,g \;
	find $(DOCDIR)/html -name \*.html -exec sed -i {} -e s,'<script type="text/javascript" src="../_static/js/jquery-fix.js"></script>',,g \;
	find $(DOCDIR)/html/doxygen -name \*.html -exec sed -i {} -e s,'..//usr/share/javascript/jquery/jquery.js','/usr/share/javascript/jquery/jquery.js',g \;

Testsuite: autopkgtest-pkg-python
