#!/usr/bin/make -f

# export DH_VERBOSE=1
# export CC=mpicc
# export FC=mpif90
# export CXX=mpicxx

# Build with clang because g++-6 gives some errors on this version of Siconos
export CC=clang
export CXX=clang++

export DEB_BUILD_OPTIONS="parallel=4"

BUILDDIR=$(CURDIR)/obj-$(DEB_HOST_GNU_TYPE)
LIBDIR=$(CURDIR)/debian/tmp/usr/lib/$(DEB_HOST_GNU_TYPE)

COMPONENTS := numerics kernel externals mechanics io control

%:
	dh $@ --with python2,sphinxdoc --parallel

override_dh_auto_clean:
	dh_auto_clean
# These files are generated by CMake in the source directory
	rm -f Docs/sphinx/conf.py \
	      Docs/sphinx/index.rst \
	      Docs/sphinx/reference/siconos_api_reference.rst

override_dh_auto_configure:
	dh_auto_configure -- \
		-DFORCE_SKIP_RPATH=1 \
		-DNO_RUNTIME_BUILD_DEP=1 \
	  -Dpython_install_options=--install-layout=deb \
		-DGAMS_DIR_INSOURCE=1 \
		-DWITH_UMFPACK=1 \
		-DWITH_BULLET=1 \
		-DWITH_HDF5=1 \
		-DWITH_DOCUMENTATION=1 \
		-DWITH_DOXY2SWIG=1

# Error: FindMUMPS.cmake:47 get_filename_component called with incorrect number of arguments
# -DWITH_MUMPS=1 \

override_dh_auto_install:
	dh_auto_install

# split up header files according to component;
# we use find and ls to identify only installed header files that are
# found within a component's directory
	for C in $(COMPONENTS); do \
	  find $(CURDIR)/$$C -name \*.h -printf 'debian/tmp/usr/include/siconos/%f\0' \
	    -or -name \*.hpp -printf 'debian/tmp/usr/include/siconos/%f\0' \
		| xargs -0 ls 2>/dev/null \
	  | while read i; do \
	    dh_install -p libsiconos-$$C-dev $$i usr/include/siconos/; \
	  done; \
	done

# launch 'make doc' with correct paths to generate docs; this should
# go in 'build', but it must be done after install due to sphinx
# needing to load SWIG-compiled modules during doc build.

# FIXME: remove $(CURDIR)/debian when sphinxcontrib packages become available.
	env PYTHONPATH=$(CURDIR)/debian/tmp/$(wildcard /usr/lib/python2*/dist-packages):$(CURDIR)/debian/python2.7/site-packages LD_LIBRARY_PATH=$(LIBDIR) $(MAKE) -C $(BUILDDIR) doc
	dh_installdocs -p siconos-doc $(BUILDDIR)/Docs/build/html
	dh_numpy

# Due to: "dh_sphinxdoc: error: unknown JavaScript code: debian/siconos-doc/usr/share/doc/siconos-doc/html/_static/doctools.js"
override_dh_sphinxdoc:
	dh_sphinxdoc -X bootstrap-sphinx.js -X doctools.js -X jquery-1.11.1.js -X jquery.js -X searchtools.js -X underscore-1.3.1.js -X underscore.js -X websupport.js

Testsuite: autopkgtest-pkg-python
